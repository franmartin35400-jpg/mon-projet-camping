<script>
  /* Thème */
  (function themeInit(){
    const html = document.documentElement;
    const saved = localStorage.getItem("theme");
    html.setAttribute("data-theme",
      saved==="light"||saved==="dark" ? saved :
      (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
    );
    const btn = document.getElementById("themeToggle");
    const icon = document.getElementById("themeIcon");
    const label = document.getElementById("themeLabel");
    function updateLabel(){ const isDark = html.getAttribute("data-theme")==="dark"; icon.textContent = isDark ? "🌙" : "🌞"; label.textContent = isDark ? "Mode sombre" : "Mode clair"; }
    btn.addEventListener("click", ()=>{ const next = html.getAttribute("data-theme")==="dark" ? "light" : "dark"; html.setAttribute("data-theme", next); localStorage.setItem("theme", next); updateLabel(); });
    updateLabel();
  })();

  /* Reveal */
  (function panelsReveal(){
    const items = document.querySelectorAll('.panel');
    const io = new IntersectionObserver((entries)=>{
      let d = 0;
      entries.forEach(e=>{
        if (e.isIntersecting){
          e.target.style.transitionDelay = (d*80)+'ms';
          e.target.classList.add('reveal');
          io.unobserve(e.target);
          d++;
        }
      });
    }, { threshold:.12 });
    items.forEach(el=> io.observe(el));
  })();

  /* Assistant de réservation — Étape 4 scindée + envoi Google Sheet onglet Reservations */
  (function wizard(){
    const start = document.getElementById('startWizard');
    const wizard = document.getElementById('wizard');

    // Cible l’onglet "Reservations" du même Apps Script
    const SCRIPT_URL = "/api/gas?sheet=Reservations";

    // État
    const STEP_DATES = 0, STEP_PEOPLE = 1, STEP_VEHICLE = 2, STEP_HAVE_PETS = 3, STEP_PET_DETAIL = 4, STEP_SUMMARY = 5;
    const state = {
      debut:"", fin:"",
      adultes: 2, enfants: 0,
      vehicule: "Van", electricite: "oui",
      animaux: "non",        // oui/non
      animalType: "",        // "chien" | "autre"
      chienSexe: "",         // "male" | "femelle"
      chienCastre: "",       // "oui" | "non"
      animauxDetails: ""     // texte libre si "autre"
    };
    let step = -1;

    function mount(){
      wizard.innerHTML = renderStep(step);
      bindHandlers();
    }

    function bindHandlers(){
      const next = wizard.querySelector('[data-next]');
      const back = wizard.querySelector('[data-back]');
      next && next.addEventListener('click', onNext);
      back && back.addEventListener('click', ()=>{ step = Math.max(STEP_DATES, step-1); mount(); });

      if (step === STEP_PET_DETAIL){
        const typeRadios = wizard.querySelectorAll('input[name="animalType"]');
        const dogBox     = wizard.querySelector('#dogBox');
        const otherBox   = wizard.querySelector('#otherBox');
        const refresh = ()=>{
          const type = wizard.querySelector('input[name="animalType"]:checked')?.value || "";
          dogBox.classList.toggle('hidden', type!=="chien");
          otherBox.classList.toggle('hidden', type!=="autre");
        };
        typeRadios.forEach(r => r.addEventListener('change', refresh));
        refresh();
      }
    }

    function onNext(){
      if (step===STEP_DATES){
        const debut = wizard.querySelector('#debut').value;
        const fin   = wizard.querySelector('#fin').value;
        if (!debut || !fin) return toast('Merci de renseigner les deux dates.');
        if (new Date(fin) < new Date(debut)) return toast('La date de fin doit être après la date de début.');
        state.debut = debut; state.fin = fin;
      }
      if (step===STEP_PEOPLE){
        const ad = Number(wizard.querySelector('#adultes').value||0);
        const en = Number(wizard.querySelector('#enfants').value||0);
        if (ad<1) return toast('Au moins 1 adulte.');
        state.adultes = ad; state.enfants = en;
      }
      if (step===STEP_VEHICLE){
        state.vehicule   = wizard.querySelector('#vehicule').value;
        state.electricite = wizard.querySelector('input[name="elec"]:checked')?.value || "non";
      }
      if (step===STEP_HAVE_PETS){
        state.animaux = wizard.querySelector('input[name="animaux"]:checked')?.value || "non";
        if (state.animaux === "non"){
          step = STEP_SUMMARY; mount(); return;
        } else {
          step = STEP_PET_DETAIL; mount(); return;
        }
      }
      if (step===STEP_PET_DETAIL){
        state.animalType = wizard.querySelector('input[name="animalType"]:checked')?.value || "";
        if (!state.animalType) return toast("Merci de choisir le type d’animal.");

        if (state.animalType === "chien"){
          state.chienSexe   = wizard.querySelector('input[name="chienSexe"]:checked')?.value || "";
          state.chienCastre = wizard.querySelector('input[name="chienCastre"]:checked')?.value || "";
          if (!state.chienSexe)   return toast("Merci d’indiquer si le chien est mâle ou femelle.");
          if (!state.chienCastre) return toast("Merci d’indiquer si le chien est castré ou non.");
          if (state.chienSexe === "male" && state.chienCastre === "non"){
            return toast("Désolés, nous n’acceptons pas les chiens mâles non castrés. Notre chien est dominant et n’accepte que les mâles castrés. Merci de votre compréhension 🙏");
          }
        } else { // autre
          state.animauxDetails = wizard.querySelector('#animauxDetails').value.trim();
          if (!state.animauxDetails) return toast("Merci de préciser le(s) animal(aux).");
        }
      }

      if (step===STEP_SUMMARY){
        submitReservation().catch(err=> toast("Erreur d’envoi : " + (err?.message || err)));
        return;
      }

      step = step + 1;
      mount();
    }

    function toast(msg){
      let n = wizard.querySelector('.warn');
      if (!n){ n=document.createElement('p'); n.className='warn'; wizard.appendChild(n); }
      n.textContent = msg;
    }

    function actions(back=true, nextLabel="Continuer"){
      return `
        <div class="actions">
          ${back?`<button type="button" class="ghost" data-back>Retour</button>`:''}
          <button type="button" data-next>${nextLabel}</button>
        </div>
      `;
    }

    function renderStep(s){
      switch(s){
        case STEP_DATES:     return renderDates();
        case STEP_PEOPLE:    return renderPeople();
        case STEP_VEHICLE:   return renderVehicle();
        case STEP_HAVE_PETS: return renderHavePets();
        case STEP_PET_DETAIL:return renderPetDetail();
        case STEP_SUMMARY:   return renderSummary();
        default:             return '';
      }
    }

    function renderDates(){
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 1 · Vos dates</h2>
        <div class="step cols">
          <label>Début du séjour<input type="date" id="debut" value="${state.debut}"></label>
          <label>Fin du séjour<input type="date" id="fin" value="${state.fin}"></label>
          <small>Vous pourrez ajuster ensuite si besoin.</small>
        </div>
        ${actions(false)}
      `;
    }
    function renderPeople(){
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 2 · Voyageurs</h2>
        <div class="step cols">
          <label>Adultes<input type="number" id="adultes" min="1" max="10" value="${state.adultes}"></label>
          <label>Enfants<input type="number" id="enfants" min="0" max="10" value="${state.enfants}"></label>
        </div>
        ${actions(true)}
      `;
    }
    function renderVehicle(){
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 3 · Véhicule</h2>
        <div class="step cols">
          <label>Type de véhicule
            <select id="vehicule">
              ${["Tente","Van","Camping-car","Caravane","Autre"].map(v=>`<option ${state.vehicule===v?"selected":""}>${v}</option>`).join("")}
            </select>
          </label>
          <label>Électricité nécessaire ?
            <div>
              <label><input type="radio" name="elec" value="oui" ${state.electricite==="oui"?"checked":""}> Oui</label>
              <label style="margin-left:12px;"><input type="radio" name="elec" value="non" ${state.electricite==="non"?"checked":""}> Non</label>
            </div>
          </label>
        </div>
        ${actions(true)}
      `;
    }
    function renderHavePets(){
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 4 · Animaux</h2>
        <div class="step">
          <label>Venez-vous avec des animaux ?
            <div>
              <label><input type="radio" name="animaux" value="non" ${state.animaux==="non"?"checked":""}> Non</label>
              <label style="margin-left:12px;"><input type="radio" name="animaux" value="oui" ${state.animaux==="oui"?"checked":""}> Oui</label>
            </div>
          </label>
        </div>
        ${actions(true, "Continuer")}
      `;
    }
    function renderPetDetail(){
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 5 · Détails des animaux</h2>
        <div class="step">
          <label>Type d’animal
            <div>
              <label><input type="radio" name="animalType" value="chien" ${state.animalType==="chien"?"checked":""}> Chien</label>
              <label style="margin-left:12px;"><input type="radio" name="animalType" value="autre" ${state.animalType==="autre"?"checked":""}> Autre</label>
            </div>
          </label>

          <div id="dogBox" class="${state.animalType==="chien"?"":"hidden"}" style="margin-top:8px;">
            <div>
              <label>Sexe du chien
                <div>
                  <label><input type="radio" name="chienSexe" value="male" ${state.chienSexe==="male"?"checked":""}> Mâle</label>
                  <label style="margin-left:12px;"><input type="radio" name="chienSexe" value="femelle" ${state.chienSexe==="femelle"?"checked":""}> Femelle</label>
                </div>
              </label>
            </div>
            <div style="margin-top:6px;">
              <label>Castré ?
                <div>
                  <label><input type="radio" name="chienCastre" value="oui" ${state.chienCastre==="oui"?"checked":""}> Oui</label>
                  <label style="margin-left:12px;"><input type="radio" name="chienCastre" value="non" ${state.chienCastre==="non"?"checked":""}> Non</label>
                </div>
              </label>
              <small>Pour des raisons de sécurité, nous n’acceptons pas les mâles non castrés (notre chien est dominant).</small>
            </div>
          </div>

          <div id="otherBox" class="${state.animalType==="autre"?"":"hidden"}" style="margin-top:8px;">
            <label>Précisez le(s) animal(aux)
              <textarea id="animauxDetails" rows="3" placeholder="Exemples : 1 chat stérilisé, 2 lapins…">${state.animauxDetails||""}</textarea>
            </label>
          </div>
        </div>
        ${actions(true)}
      `;
    }
    function renderSummary(){
      const animauxTxt = (state.animaux==="non")
        ? "aucun"
        : (state.animalType==="chien"
            ? `chien (${state.chienSexe}${state.chienSexe==="male" ? (state.chienCastre==="oui" ? ", castré" : ", non castré") : ""})`
            : `autre : ${state.animauxDetails || "non précisé"}`);
      const resume = `
        <ul style="margin:0; padding-left:18px;">
          <li><strong>Dates :</strong> ${state.debut} → ${state.fin}</li>
          <li><strong>Voyageurs :</strong> ${state.adultes} adulte(s)${state.enfants?`, ${state.enfants} enfant(s)`:``}</li>
          <li><strong>Véhicule :</strong> ${state.vehicule}${state.electricite==="oui"?" · électricité":""}</li>
          <li><strong>Animaux :</strong> ${animauxTxt}</li>
        </ul>
      `;
      return `
        <h2 style="font-family:Poppins; margin:0 0 8px;">Étape 6 · Récapitulatif</h2>
        <div class="summary">${resume}</div>
        <div class="actions">
          <button type="button" class="ghost" data-back>Retour</button>
          <button type="button" data-next>Envoyer la demande</button>
        </div>
        <p id="finalMsg" class="ok hidden" style="margin-top:10px;"></p>
      `;
    }

    async function submitReservation(){
      const payload = {
        debut: state.debut, fin: state.fin,
        adultes: String(state.adultes), enfants: String(state.enfants),
        vehicule: state.vehicule, electricite: state.electricite,
        animaux: state.animaux, animalType: state.animalType,
        chienSexe: state.chienSexe, chienCastre: state.chienCastre,
        animauxDetails: state.animauxDetails
      };
      const r = await fetch(SCRIPT_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const data = await r.json().catch(()=>({ok:false,error:"Réponse non-JSON"}));
      const msg = wizard.querySelector('#finalMsg') || (()=>{ const p=document.createElement('p'); p.id='finalMsg'; p.className='ok'; p.style.marginTop='10px'; wizard.appendChild(p); return p; })();
      if (data.ok){ msg.textContent = "✅ Demande envoyée ! Nous vous recontactons rapidement pour confirmer la disponibilité et finaliser la réservation."; }
      else{ msg.className='warn'; msg.textContent = "Une erreur est survenue : " + (data.error || "inconnue"); }
    }

    // Start
    start.addEventListener('click', ()=>{
      step = STEP_DATES;
      mount();
      wizard.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // Dernier bouton
    wizard.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-next]');
      if (!btn) return;
      if (step===STEP_SUMMARY){
        // géré dans onNext → submitReservation()
      }
    });
  })();
</script>