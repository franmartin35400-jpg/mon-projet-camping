<!DOCTYPE html>
<html lang="fr" data-theme="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RÃ©servations â€“ Camping Rivassland</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="app.js" defer></script>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body data-bg-day="resa-jour.jpg" data-bg-night="resa-nuit.jpg">
  <div class="page-bg" aria-hidden="true"></div>
  <div class="page-bg-night" aria-hidden="true"></div>

  <header class="topbar">
    <img src="logo.jpg" alt="Camping Rivassland" class="logo">
    <nav class="nav">
      <a href="accueil.html">Accueil</a>
      <a href="lieu.html">Lieu</a>
      <a href="reservation.html" aria-current="page">RÃ©servations</a>
      <a href="index.html">Avis</a>
    </nav>
    <div class="controls" style="justify-self:end; display:flex; align-items:center; gap:8px">
      <button id="accountBtn" class="ghost" type="button">Se connecter</button>
      <span id="userName" class="hint" style="min-width:0"></span>
      <button id="themeToggle" class="theme-toggle"><span id="themeIcon">ðŸŒž</span><span id="themeLabel">Mode clair</span></button>
    </div>
  </header>

  <!-- Overlay â€œAccÃ¨s refusÃ©â€ -->
  <div id="refuse" class="overlay">
    <div class="card">
      <h2 style="font-family:Poppins;margin:0 0 8px;">AccÃ¨s refusÃ©</h2>
      <p class="warn" style="margin:0 0 10px;">
        Nous nâ€™acceptons pas les chiens <strong>mÃ¢les non castrÃ©s</strong>. Notre chien rÃ©sidant est dominant : cela garantit la sÃ©curitÃ© et le confort de tous.
      </p>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button id="refuseBack" class="ghost">Revenir aux animaux</button>
        <a href="accueil.html" class="theme-toggle" style="text-decoration:none;display:inline-flex;align-items:center">Retour Ã  lâ€™accueil</a>
      </div>
    </div>
  </div>

  <main class="wrap grid-2">
    <!-- Intro -->
    <section class="panel">
      <h1>RÃ©server un emplacement</h1>
      <p class="lead">RÃ©servation rapide : indiquez vos <strong>dates</strong>, le <strong>nombre de personnes</strong>, votre <strong>vÃ©hicule</strong> et si vous avez des <strong>animaux</strong>.</p>
      <div class="divider"></div>
      <div class="actions"><button id="startWizard">Commencer</button></div>
    </section>

    <!-- Wizard -->
    <section class="panel" id="wizard" aria-live="polite" aria-atomic="true"></section>
  </main>

  <script>
    const overlay=document.getElementById('refuse'), backBtn=document.getElementById('refuseBack');
    function showRefuse(){ overlay.style.display="grid"; }
    function hideRefuse(){ overlay.style.display="none"; }
    if(backBtn) backBtn.addEventListener('click', ()=>{ hideRefuse(); });

    (function wizard(){
      const start=document.getElementById('startWizard'), root=document.getElementById('wizard');
      if(!start||!root) return;
      const API="/api/gas?sheet=Reservations";
      const STEP={DATES:0,PEOPLE:1,VEHICLE:2,HAVE_PETS:3,PET_TYPE:4,DOG_SEX:5,DOG_CASTRE:6,OTHER_DETAILS:7,SUMMARY:8};
      const labels=["Dates","Voyageurs","VÃ©hicule","Animaux","Type","Sexe","CastrÃ©","DÃ©tails","RÃ©cap"];
      const st={debut:"",fin:"",adultes:2,enfants:0,vehicule:"Van",electricite:"oui",animaux:"non",animalType:"",chienSexe:"",chienCastre:"",animauxDetails:""};
      let step=-1;

      function mount(){ root.innerHTML=`${stepper(step)}<div class="fade-in">${view(step)}</div>`; bind(); updateStepper(); }
      function bind(){
        const n=root.querySelector('[data-next]'); const b=root.querySelector('[data-back]');
        if(n) n.addEventListener('click',onNext); if(b) b.addEventListener('click',()=>{step=Math.max(STEP.DATES,step-1); hideRefuse(); mount()});
      }
      function onNext(){
        if(step===STEP.DATES){ const d=root.querySelector('#debut')?.value,f=root.querySelector('#fin')?.value; if(!d||!f) return toast("Dates manquantes"); if(new Date(f)<new Date(d)) return toast("Fin avant dÃ©but"); st.debut=d;st.fin=f; step=STEP.PEOPLE; return mount(); }
        if(step===STEP.PEOPLE){ const a=+root.querySelector('#adultes').value||0, e=+root.querySelector('#enfants').value||0; if(a<1) return toast("Au moins 1 adulte"); st.adultes=a;st.enfants=e; step=STEP.VEHICLE; return mount(); }
        if(step===STEP.VEHICLE){ st.vehicule=root.querySelector('#vehicule').value; st.electricite=root.querySelector('input[name="elec"]:checked')?.value||"non"; step=STEP.HAVE_PETS; return mount(); }
        if(step===STEP.HAVE_PETS){ st.animaux=root.querySelector('input[name="animaux"]:checked')?.value||"non"; if(st.animaux==="non"){ step=STEP.SUMMARY; return mount(); } step=STEP.PET_TYPE; return mount(); }
        if(step===STEP.PET_TYPE){ st.animalType=root.querySelector('input[name="animalType"]:checked')?.value||""; if(!st.animalType) return toast("Choisissez le type"); if(st.animalType==="chien"){ step=STEP.DOG_SEX; } else { step=STEP.OTHER_DETAILS; } return mount(); }
        if(step===STEP.DOG_SEX){ st.chienSexe=root.querySelector('input[name="chienSexe"]:checked')?.value||""; if(!st.chienSexe) return toast("Sexe du chien"); if(st.chienSexe==="male"){ step=STEP.DOG_CASTRE; } else { step=STEP.SUMMARY; } return mount(); }
        if(step===STEP.DOG_CASTRE){
          st.chienCastre=root.querySelector('input[name="chienCastre"]:checked')?.value||"";
          if(!st.chienCastre) return toast("Castration ?");
          if(st.chienCastre==="non"){ showRefuse(); return; }
          step=STEP.SUMMARY; return mount();
        }
        if(step===STEP.OTHER_DETAILS){ st.animauxDetails=(root.querySelector('#animauxDetails')?.value||"").trim(); if(!st.animauxDetails) return toast("PrÃ©cisez lâ€™animal"); step=STEP.SUMMARY; return mount(); }
        if(step===STEP.SUMMARY){ submit().catch(()=>toast("Erreur dâ€™envoi")); }
      }
      function toast(t){ let n=root.querySelector('.warn'); if(!n){n=document.createElement('p');n.className='warn';root.appendChild(n);} n.textContent=t; }

      function stepper(s){ return `<div class="stepper">${labels.map((lab,i)=>`
          <div class="item ${i<s?'done':i===s?'active':''}">
            <div class="dot">${i<s?'âœ”ï¸Ž':i+1}</div>
            <div class="label">${lab}</div>
          </div>`).join(`<div class="bar"></div>`)}</div>`; }
      function updateStepper(){
        const nodes=root.querySelectorAll('.stepper .item');
        nodes.forEach((n,i)=>{ n.classList.toggle('active',i===step); n.classList.toggle('done',i<step); const d=n.querySelector('.dot'); if(d) d.textContent=i<step?"âœ”ï¸Ž":String(i+1); });
      }
      function actions(back=true,next="Continuer"){ return `<div class="actions">${back?`<button class="ghost" data-back>Retour</button>`:""}<button data-next>${next}</button></div>`; }

      function view(s){
        if(s===STEP.DATES) return `<h2>Ã‰tape 1 Â· Vos dates</h2>
          <div class="step cols"><label>DÃ©but<input type="date" id="debut" value="${st.debut}"></label><label>Fin<input type="date" id="fin" value="${st.fin}"></label></div>${actions(false)}`;
        if(s===STEP.PEOPLE) return `<h2>Ã‰tape 2 Â· Voyageurs</h2>
          <div class="step cols"><label>Adultes<input type="number" id="adultes" min="1" value="${st.adultes}"></label><label>Enfants<input type="number" id="enfants" min="0" value="${st.enfants}"></label></div>${actions(true)}`;
        if(s===STEP.VEHICLE) return `<h2>Ã‰tape 3 Â· VÃ©hicule</h2>
          <div class="step cols">
            <label>Type<select id="vehicule">${["Tente","Van","Camping-car","Caravane","Autre"].map(v=>`<option ${st.vehicule===v?"selected":""}>${v}</option>`).join("")}</select></label>
            <label>Ã‰lectricitÃ© ?<div><label><input type="radio" name="elec" value="oui" ${st.electricite==="oui"?"checked":""}> Oui</label><label style="margin-left:12px"><input type="radio" name="elec" value="non" ${st.electricite==="non"?"checked":""}> Non</label></div></label>
          </div>${actions(true)}`;
        if(s===STEP.HAVE_PETS) return `<h2>Ã‰tape 4 Â· Animaux</h2>
          <div class="step"><label>Venez-vous avec des animaux ?
            <div><label><input type="radio" name="animaux" value="non" ${st.animaux==="non"?"checked":""}> Non</label>
            <label style="margin-left:12px"><input type="radio" name="animaux" value="oui" ${st.animaux==="oui"?"checked":""}> Oui</label></div>
          </label></div>${actions(true,"Continuer")}`;
        if(s===STEP.PET_TYPE) return `<h2>Ã‰tape 5 Â· Type dâ€™animal</h2>
          <div class="step"><label>Quel type ?
            <div><label><input type="radio" name="animalType" value="chien" ${st.animalType==="chien"?"checked":""}> Chien</label>
            <label style="margin-left:12px"><input type="radio" name="animalType" value="autre" ${st.animalType==="autre"?"checked":""}> Autre</label></div>
          </label></div>${actions(true)}`;
        if(s===STEP.DOG_SEX) return `<h2>Ã‰tape 6 Â· Sexe du chien</h2>
          <div class="step"><div><label>
            <div><label><input type="radio" name="chienSexe" value="male" ${st.chienSexe==="male"?"checked":""}> MÃ¢le</label>
            <label style="margin-left:12px"><input type="radio" name="chienSexe" value="femelle" ${st.chienSexe==="femelle"?"checked":""}> Femelle</label></div>
          </label></div><small>Si mÃ¢le â†’ question suivante.</small></div>${actions(true)}`;
        if(s===STEP.DOG_CASTRE) return `<h2>Ã‰tape 7 Â· Castration</h2>
          <div class="step"><label>Votre chien mÃ¢le est-il castrÃ© ?
            <div><label><input type="radio" name="chienCastre" value="oui" ${st.chienCastre==="oui"?"checked":""}> Oui</label>
            <label style="margin-left:12px"><input type="radio" name="chienCastre" value="non" ${st.chienCastre==="non"?"checked":""}> Non</label></div>
          </label><small>Par sÃ©curitÃ©, nous nâ€™acceptons pas les mÃ¢les non castrÃ©s.</small></div>${actions(true)}`;
        if(s===STEP.OTHER_DETAILS) return `<h2>Ã‰tape 6 Â· DÃ©tails des animaux</h2>
          <div class="step"><label>PrÃ©cisions<textarea id="animauxDetails" rows="3" placeholder="Ex. 1 chat stÃ©rilisÃ©, 2 lapinsâ€¦">${st.animauxDetails||""}</textarea></label></div>${actions(true)}`;
        if(s===STEP.SUMMARY){
          const animauxTxt=(st.animaux==="non")?"aucun":(st.animalType==="chien"?`chien (${st.chienSexe}${st.chienSexe==="male"?(st.chienCastre==="oui"?", castrÃ©":", non castrÃ©"):""})`:`autre : ${st.animauxDetails||"non prÃ©cisÃ©"}`);
          return `<h2>Ã‰tape 8 Â· RÃ©capitulatif</h2>
            <div class="summary">
              <ul style="margin:0;padding-left:18px">
                <li><strong>Dates :</strong> ${st.debut} â†’ ${st.fin}</li>
                <li><strong>Voyageurs :</strong> ${st.adultes} adulte(s)${st.enfants?`, ${st.enfants} enfant(s)`:``}</li>
                <li><strong>VÃ©hicule :</strong> ${st.vehicule}${st.electricite==="oui"?" Â· Ã©lectricitÃ©":""}</li>
                <li><strong>Animaux :</strong> ${animauxTxt}</li>
              </ul>
            </div>
            <div class="actions"><button class="ghost" data-back>Retour</button><button data-next>Envoyer la demande</button></div>
            <p id="finalMsg" class="ok" style="display:none;margin-top:10px"></p>`;
        }
        return "";
      }

      async function submit(){
        // ðŸ”’ Exiger d'Ãªtre connectÃ©
        const REQUIRE_AUTH = true;
        if (REQUIRE_AUTH) {
          if (!(window.netlifyIdentity && netlifyIdentity.currentUser())) {
            alert('Connectez-vous pour envoyer votre demande.');
            netlifyIdentity.open('login');
            return;
          }
        }
        const payload={debut:st.debut,fin:st.fin,adultes:String(st.adultes),enfants:String(st.enfants),vehicule:st.vehicule,electricite:st.electricite,animaux:st.animaux,animalType:st.animalType,chienSexe:st.chienSexe,chienCastre:st.chienCastre,animauxDetails:st.animauxDetails};
        const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const data=await r.json().catch(()=>({ok:false}));
        const m=document.getElementById('finalMsg'); if(!m) return;
        if(data.ok){ m.style.display="block"; m.textContent="âœ… Demande envoyÃ©e ! Nous vous recontactons rapidement."; }
        else { m.style.display="block"; m.className="warn"; m.textContent="Erreur dâ€™envoi."; }
      }

      start.addEventListener('click', ()=>{ step=STEP.DATES; mount(); root.scrollIntoView({behavior:'smooth',block:'start'}); });
      root.addEventListener('click', (e)=>{ if(e.target.closest && e.target.closest('[data-next]') && step===STEP.SUMMARY){ submit(); } });
    })();
  </script>
</body>
</html>